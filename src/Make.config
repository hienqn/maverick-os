# -*- makefile -*-

SHELL = /bin/sh

VPATH = $(SRCDIR)

# =============================================================================
# Architecture Selection
# =============================================================================
# Default to i386 for backward compatibility. Override with ARCH=riscv64.
ARCH ?= i386

# Validate architecture
ifneq ($(ARCH),i386)
ifneq ($(ARCH),riscv64)
$(error Unknown ARCH=$(ARCH). Supported: i386, riscv64)
endif
endif

# Architecture-specific defines
ARCH_UPPER := $(shell echo $(ARCH) | tr '[:lower:]' '[:upper:]')

# =============================================================================
# Toolchain Configuration
# =============================================================================

ifeq ($(ARCH),i386)
# -----------------------------------------------------------------------------
# i386 Toolchain
# -----------------------------------------------------------------------------
# If the host appears to be x86, use the normal tools.
# If it's x86-64, use the compiler and linker in 32-bit mode.
# Otherwise assume cross-tools are installed as i386-elf-*.
X86 = i.86\|pentium.*\|[pk][56]\|nexgen\|viac3\|6x86\|athlon.*\|i86pc
X86_64 = x86_64
ifneq (0, $(shell expr `uname -m` : '$(X86)'))
  CC = gcc
  LD = ld
  OBJCOPY = objcopy
else
  ifneq (0, $(shell expr `uname -m` : '$(X86_64)'))
    CC = gcc -m32
    LD = ld -melf_i386
    OBJCOPY = objcopy
  else
    CC = i686-linux-gnu-gcc -m32 #i386-elf-gcc
    LD = i686-linux-gnu-ld #i386-elf-ld
    OBJCOPY = i686-linux-gnu-objcopy #i386-elf-objcopy
  endif
endif

# i386-specific flags
ARCH_CFLAGS = -march=i686 -m32
ARCH_ASFLAGS =
ARCH_LDFLAGS =

else ifeq ($(ARCH),riscv64)
# -----------------------------------------------------------------------------
# RISC-V 64-bit Toolchain
# -----------------------------------------------------------------------------
# Try bare-metal toolchain first, fall back to linux-gnu
ifeq ($(strip $(shell command -v riscv64-unknown-elf-gcc 2>/dev/null)),)
  # Bare-metal not found, try linux-gnu (works for freestanding kernels)
  CROSS_COMPILE ?= riscv64-linux-gnu-
else
  CROSS_COMPILE ?= riscv64-unknown-elf-
endif
CC = $(CROSS_COMPILE)gcc
LD = $(CROSS_COMPILE)ld
OBJCOPY = $(CROSS_COMPILE)objcopy

# RV64GC: General + Compressed + FP extensions
# medany: Medium Any code model for position-independent kernel
# ffreestanding: Building a freestanding kernel, not hosted program
ARCH_CFLAGS = -march=rv64gc -mabi=lp64d -mcmodel=medany -ffreestanding
ARCH_ASFLAGS = -march=rv64gc -mabi=lp64d
# Linker flags: LD_RAW_FLAGS for direct ld use, ARCH_LDFLAGS for gcc -Wl
ARCH_LDFLAGS = -Wl,-melf64lriscv
LD_RAW_FLAGS = -melf64lriscv

# RISC-V doesn't need a separate loader (OpenSBI handles boot)
NO_LOADER = 1

endif

ifeq ($(strip $(shell command -v $(CC) 2> /dev/null)),)
$(warning *** Compiler ($(CC)) not found.  Did you set $$PATH properly?  Please refer to the Getting Started section in the documentation for details. ***)
endif

# =============================================================================
# Common Compiler Flags
# =============================================================================
DEFINES = -DARCH_$(ARCH_UPPER)
WARNINGS = -Wall -W -Wstrict-prototypes -Wmissing-prototypes -Wsystem-headers
CFLAGS = -ggdb3 -O0 $(ARCH_CFLAGS) -fno-pic -fno-inline
CPPFLAGS = -nostdinc -I$(SRCDIR) -I$(SRCDIR)/lib -I$(SRCDIR)/arch/$(ARCH) -I$(SRCDIR)/arch/common
ASFLAGS = -Wa,--gstabs $(ARCH_ASFLAGS)
LDFLAGS = -z noseparate-code $(ARCH_LDFLAGS)
DEPS = -MMD -MF $(@:.o=.d)

# Turn off -fstack-protector, which we don't support.
ifeq ($(strip $(shell echo | $(CC) -fno-stack-protector -E - > /dev/null 2>&1; echo $$?)),0)
CFLAGS += -fno-stack-protector
endif

# Turn off --build-id in the linker, which confuses the Pintos loader.
ifeq ($(strip $(shell $(LD) --help | grep -q build-id; echo $$?)),0)
LDFLAGS += -Wl,--build-id=none
endif

%.o: %.c
	$(CC) -c $< -o $@ $(CFLAGS) $(CPPFLAGS) $(WARNINGS) $(DEFINES) $(DEPS)

%.o: %.S
	$(CC) -c $< -o $@ $(ASFLAGS) $(CPPFLAGS) $(DEFINES) $(DEPS)

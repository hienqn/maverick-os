# -*- makefile -*-
# =============================================================================
# PintOS Build Configuration (Make.config)
# =============================================================================
# Detects host architecture and configures the cross-compilation toolchain.
# PintOS targets i686 (32-bit x86), so on 64-bit hosts we need -m32 flags.
# =============================================================================

SHELL = /bin/sh

# =============================================================================
# Tooling Selection (Perl vs Bun/TypeScript)
# =============================================================================
# PintOS utilities (pintos, pintos-mkdisk, backtrace, check-test) have both
# Perl and Bun/TypeScript implementations. Bun is the default.
#
# Usage:
#   make check              # Use Bun/TypeScript (default)
#   make check USE_BUN=0    # Use Perl (legacy)
# =============================================================================

USE_BUN ?= 1

ifeq ($(USE_BUN),1)
  PINTOS_UTILS_DIR = $(SRCDIR)/utils/bun/bin
else
  PINTOS_UTILS_DIR = $(SRCDIR)/utils
endif

# Utility commands (used by Make.tests and other build scripts)
PINTOS = $(PINTOS_UTILS_DIR)/pintos
PINTOS_MKDISK = $(PINTOS_UTILS_DIR)/pintos-mkdisk
BACKTRACE = $(PINTOS_UTILS_DIR)/backtrace
PINTOS_TEST = $(PINTOS_UTILS_DIR)/pintos-test

# Test verification command
# Perl: perl -I$(SRCDIR) checker.ck test-name result-file
# Bun:  check-test checker.ck test-name result-file
ifeq ($(USE_BUN),1)
  CHECK_TEST = $(PINTOS_UTILS_DIR)/check-test
else
  CHECK_TEST = perl -I$(SRCDIR)
endif

# VPATH: Search path for source files (allows out-of-tree builds)
VPATH = $(SRCDIR)

# =============================================================================
# Toolchain Detection
# =============================================================================
# PintOS requires 32-bit x86 (i686) binaries. This section detects the host
# architecture and configures the appropriate compiler/linker settings.
#
# Three cases:
#   1. Native x86 (32-bit): Use standard tools
#   2. x86_64 (64-bit): Use -m32 flag for 32-bit output
#   3. Other (ARM, etc.): Use cross-compiler (i686-linux-gnu-*)
# =============================================================================

# Regex patterns to detect x86 architectures
X86 = i.86\|pentium.*\|[pk][56]\|nexgen\|viac3\|6x86\|athlon.*\|i86pc
X86_64 = x86_64

# Detect host and set toolchain accordingly
ifneq (0, $(shell expr `uname -m` : '$(X86)'))
  # Native 32-bit x86: use standard tools
  CC = gcc
  LD = ld
  OBJCOPY = objcopy
else
  ifneq (0, $(shell expr `uname -m` : '$(X86_64)'))
    # 64-bit x86: compile in 32-bit mode
    CC = gcc -m32
    LD = ld -melf_i386
    OBJCOPY = objcopy
  else
    # Non-x86 host (ARM, etc.): use cross-compiler
    CC = i686-linux-gnu-gcc -m32 #i386-elf-gcc
    LD = i686-linux-gnu-ld #i386-elf-ld
    OBJCOPY = i686-linux-gnu-objcopy #i386-elf-objcopy
  endif
endif

# Warn if compiler not found
ifeq ($(strip $(shell command -v $(CC) 2> /dev/null)),)
$(warning *** Compiler ($(CC)) not found.  Did you set $$PATH properly?  Please refer to the Getting Started section in the documentation for details. ***)
endif

# =============================================================================
# Compiler Flags
# =============================================================================

# Preprocessor defines (set per-project in Make.vars, e.g., -DUSERPROG -DVM)
DEFINES =

# Warning flags (strict C standards compliance)
WARNINGS = -Wall -W -Wstrict-prototypes -Wmissing-prototypes -Wsystem-headers

# C compiler flags:
#   -ggdb3: Maximum debug info for GDB
#   -O0: No optimization (easier debugging)
#   -march=i686: Target Pentium Pro and later
#   -fno-pic: No position-independent code (not needed for kernel)
#   -fno-inline: Don't inline functions (clearer stack traces)
CFLAGS = -ggdb3 -O0 -march=i686 -fno-pic -fno-inline

# Preprocessor flags:
#   -nostdinc: Don't use system headers (we provide our own)
#   -I: Include paths for PintOS headers
CPPFLAGS = -nostdinc -I$(SRCDIR) -I$(SRCDIR)/lib

# Assembler flags: Include STABS debug info
ASFLAGS = -Wa,--gstabs

# Linker flags
LDFLAGS = -z noseparate-code

# Dependency generation: Create .d files for header dependency tracking
# -MMD: Generate dependency file; -MF: Output file name
DEPS = -MMD -MF $(@:.o=.d)

# =============================================================================
# Compiler Feature Detection
# =============================================================================

# Disable stack protector (PintOS doesn't support it)
# Tests if compiler accepts the flag, then adds it if supported
ifeq ($(strip $(shell echo | $(CC) -fno-stack-protector -E - > /dev/null 2>&1; echo $$?)),0)
CFLAGS += -fno-stack-protector
endif

# Disable build-id (confuses PintOS bootloader which expects raw binary)
ifeq ($(strip $(shell $(LD) --help | grep -q build-id; echo $$?)),0)
LDFLAGS += -Wl,--build-id=none
endif

# =============================================================================
# Pattern Rules
# =============================================================================

# Compile C source files to object files
# $<: source file, $@: target object file
%.o: %.c
	$(CC) -c $< -o $@ $(CFLAGS) $(CPPFLAGS) $(WARNINGS) $(DEFINES) $(DEPS)

# Compile assembly files to object files
%.o: %.S
	$(CC) -c $< -o $@ $(ASFLAGS) $(CPPFLAGS) $(DEFINES) $(DEPS)

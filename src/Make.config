# -*- makefile -*-
# =============================================================================
# PintOS Build Configuration (Make.config)
# =============================================================================
# Detects host architecture and configures the cross-compilation toolchain.
# PintOS targets i686 (32-bit x86), so on 64-bit hosts we need -m32 flags.
# =============================================================================

SHELL = /bin/sh

# =============================================================================
# Tooling (Bun/TypeScript)
# =============================================================================
# PintOS utilities are implemented in Bun/TypeScript.
# =============================================================================

PINTOS_UTILS_DIR = $(SRCDIR)/utils/bin

# Utility commands (used by Make.tests and other build scripts)
PINTOS = $(PINTOS_UTILS_DIR)/pintos
PINTOS_MKDISK = $(PINTOS_UTILS_DIR)/pintos-mkdisk
BACKTRACE = $(PINTOS_UTILS_DIR)/backtrace
PINTOS_TEST = $(PINTOS_UTILS_DIR)/pintos-test
CHECK_TEST = $(PINTOS_UTILS_DIR)/check-test
MAKE_GRADE = $(PINTOS_UTILS_DIR)/make-grade

# VPATH: Search path for source files (allows out-of-tree builds)
VPATH = $(SRCDIR)

# =============================================================================
# Architecture Selection
# =============================================================================
# Default to i386 for backward compatibility. Override with ARCH=riscv64.
ARCH ?= i386

# Validate architecture
ifneq ($(ARCH),i386)
ifneq ($(ARCH),riscv64)
$(error Unknown ARCH=$(ARCH). Supported: i386, riscv64)
endif
endif

# Architecture-specific defines (use deferred assignment so Make.vars can override ARCH)
ARCH_UPPER = $(shell echo $(ARCH) | tr '[:lower:]' '[:upper:]')

# =============================================================================
# Toolchain Configuration
# =============================================================================

ifeq ($(ARCH),i386)
# -----------------------------------------------------------------------------
# i386 Toolchain
# -----------------------------------------------------------------------------
# PintOS requires 32-bit x86 (i686) binaries. This section detects the host
# architecture and configures the appropriate compiler/linker settings.
#
# Three cases:
#   1. Native x86 (32-bit): Use standard tools
#   2. x86_64 (64-bit): Use -m32 flag for 32-bit output
#   3. Other (ARM, etc.): Use cross-compiler (i686-linux-gnu-*)

# Regex patterns to detect x86 architectures
X86 = i.86\|pentium.*\|[pk][56]\|nexgen\|viac3\|6x86\|athlon.*\|i86pc
X86_64 = x86_64

# Detect host and set toolchain accordingly
ifneq (0, $(shell expr `uname -m` : '$(X86)'))
  # Native 32-bit x86: use standard tools
  CC = gcc
  LD = ld
  OBJCOPY = objcopy
else
  ifneq (0, $(shell expr `uname -m` : '$(X86_64)'))
    # 64-bit x86: compile in 32-bit mode
    CC = gcc -m32
    LD = ld -melf_i386
    OBJCOPY = objcopy
  else
    # Non-x86 host (ARM, etc.): use cross-compiler
    CC = i686-linux-gnu-gcc -m32 #i386-elf-gcc
    LD = i686-linux-gnu-ld #i386-elf-ld
    OBJCOPY = i686-linux-gnu-objcopy #i386-elf-objcopy
  endif
endif

# i386-specific flags
ARCH_CFLAGS = -march=i686 -m32
ARCH_ASFLAGS =
ARCH_LDFLAGS =

else ifeq ($(ARCH),riscv64)
# -----------------------------------------------------------------------------
# RISC-V 64-bit Toolchain
# -----------------------------------------------------------------------------
# Try bare-metal toolchain first, fall back to linux-gnu
ifeq ($(strip $(shell command -v riscv64-unknown-elf-gcc 2>/dev/null)),)
  # Bare-metal not found, try linux-gnu (works for freestanding kernels)
  CROSS_COMPILE ?= riscv64-linux-gnu-
else
  CROSS_COMPILE ?= riscv64-unknown-elf-
endif
CC = $(CROSS_COMPILE)gcc
LD = $(CROSS_COMPILE)ld
OBJCOPY = $(CROSS_COMPILE)objcopy

# RV64GC: General + Compressed + FP extensions
# medany: Medium Any code model for position-independent kernel
# ffreestanding: Building a freestanding kernel, not hosted program
ARCH_CFLAGS = -march=rv64gc -mabi=lp64d -mcmodel=medany -ffreestanding
ARCH_ASFLAGS = -march=rv64gc -mabi=lp64d
# Linker flags: LD_RAW_FLAGS for direct ld use, ARCH_LDFLAGS for gcc -Wl
ARCH_LDFLAGS = -Wl,-melf64lriscv
LD_RAW_FLAGS = -melf64lriscv

# RISC-V doesn't need a separate loader (OpenSBI handles boot)
NO_LOADER = 1

endif

# Warn if compiler not found
ifeq ($(strip $(shell command -v $(CC) 2> /dev/null)),)
$(warning *** Compiler ($(CC)) not found.  Did you set $$PATH properly?  Please refer to the Getting Started section in the documentation for details. ***)
endif

# =============================================================================
# Common Compiler Flags
# =============================================================================

# Preprocessor defines: Architecture define plus per-project defines from Make.vars
DEFINES = -DARCH_$(ARCH_UPPER)

# Warning flags (strict C standards compliance)
WARNINGS = -Wall -W -Wstrict-prototypes -Wmissing-prototypes -Wsystem-headers

# C compiler flags:
#   -ggdb3: Maximum debug info for GDB
#   -O0: No optimization (easier debugging)
#   -fno-pic: No position-independent code (not needed for kernel)
#   -fno-inline: Don't inline functions (clearer stack traces)
#   ARCH_CFLAGS: Architecture-specific flags (e.g., -march=i686 -m32)
CFLAGS = -ggdb3 -O0 $(ARCH_CFLAGS) -fno-pic -fno-inline

# Preprocessor flags:
#   -nostdinc: Don't use system headers (we provide our own)
#   -I: Include paths for PintOS headers
CPPFLAGS = -nostdinc -I$(SRCDIR) -I$(SRCDIR)/lib -I$(SRCDIR)/arch/$(ARCH) -I$(SRCDIR)/arch/common

# Assembler flags: Include STABS debug info + architecture-specific flags
ASFLAGS = -Wa,--gstabs $(ARCH_ASFLAGS)

# Linker flags
LDFLAGS = -z noseparate-code $(ARCH_LDFLAGS)

# Dependency generation: Create .d files for header dependency tracking
# -MMD: Generate dependency file; -MF: Output file name
DEPS = -MMD -MF $(@:.o=.d)

# =============================================================================
# Compiler Feature Detection
# =============================================================================

# Disable stack protector (PintOS doesn't support it)
# Tests if compiler accepts the flag, then adds it if supported
ifeq ($(strip $(shell echo | $(CC) -fno-stack-protector -E - > /dev/null 2>&1; echo $$?)),0)
CFLAGS += -fno-stack-protector
endif

# Disable build-id (confuses PintOS bootloader which expects raw binary)
ifeq ($(strip $(shell $(LD) --help | grep -q build-id; echo $$?)),0)
LDFLAGS += -Wl,--build-id=none
endif

# =============================================================================
# Pattern Rules
# =============================================================================

# Compile C source files to object files
# $<: source file, $@: target object file
%.o: %.c
	$(CC) -c $< -o $@ $(CFLAGS) $(CPPFLAGS) $(WARNINGS) $(DEFINES) $(DEPS)

# Compile assembly files to object files
%.o: %.S
	$(CC) -c $< -o $@ $(ASFLAGS) $(CPPFLAGS) $(DEFINES) $(DEPS)
